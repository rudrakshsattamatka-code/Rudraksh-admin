<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Admin Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
        .tabs { display: flex; background: #333; color: white; flex-wrap: wrap; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { background: #555; border-bottom-color: #4CAF50; }
        .content { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button { padding: 10px 15px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .logout { background: #f44336; float: right; }
    </style>
</head>
<body>
    <div style="padding: 10px; background: #222; color: white; text-align: center;">
        <h2>Admin Panel</h2>
        <button class="logout" onclick="logout()">Logout</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('payments')">Payments</div>
        <div class="tab" onclick="showTab('markets')">Markets</div>
        <div class="tab" onclick="showTab('formulas')">Formulas</div>
        <div class="tab" onclick="showTab('settings')">Settings</div>
    </div>

    <div id="paymentsTab" class="content" style="display: block;">
        <h3>Pending Payments</h3>
        <div id="paymentsList">Loading...</div>
    </div>

    <div id="marketsTab" class="content" style="display: none;">
        <h3>Edit Markets</h3>
        <div id="marketsList"></div>
    </div>

    <div id="formulasTab" class="content" style="display: none;">
        <h3>Edit Formulas</h3>
        <div id="formulasList"></div>
    </div>

    <div id="settingsTab" class="content" style="display: none;">
        <h3>Site Settings</h3>
        <div id="settingsForm"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCXL6EiiLg_3lILCOSA_iFgeL8Y2nPEEnw",
            authDomain: "rudraksh-premium.firebaseapp.com",
            projectId: "rudraksh-premium",
            storageBucket: "rudraksh-premium.firebasestorage.app",
            messagingSenderId: "99880475040",
            appId: "1:99880475040:web:c64c708e9bec7fed0a6cc5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            const tokenResult = await user.getIdTokenResult();
            if (!tokenResult.claims.admin) {
                alert('Access denied');
                auth.signOut();
                window.location.href = 'login.html';
            }
        });

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.style.display = 'none');
            document.getElementById(tabName + 'Tab').style.display = 'block';
            event.target.classList.add('active');
            if (tabName === 'payments') loadPayments();
            if (tabName === 'markets') loadMarkets();
            if (tabName === 'formulas') loadFormulas();
            if (tabName === 'settings') loadSettings();
        }

        // Payments tab
        function loadPayments() {
            db.collection('payments').where('status', '==', 'pending').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : '';
                    html += `
                        <div class="card">
                            <p><strong>${data.userEmail}</strong> (${data.plan})</p>
                            <p>Time: ${date}</p>
                            <button onclick="approvePayment('${doc.id}', '${data.userId}', '${data.plan}')">Approve</button>
                        </div>
                    `;
                });
                document.getElementById('paymentsList').innerHTML = html || 'No pending payments.';
            });
        }

        function approvePayment(paymentId, userId, plan) {
            const expiryDays = plan === '1day' ? 1 : 7;
            const expiry = new Date();
            expiry.setDate(expiry.getDate() + expiryDays);

            db.runTransaction(async transaction => {
                transaction.update(db.collection('payments').doc(paymentId), { status: 'approved', approvedAt: firebase.firestore.FieldValue.serverTimestamp() });
                transaction.set(db.collection('subscriptions').doc(userId), {
                    active: true,
                    plan: plan,
                    expiry: firebase.firestore.Timestamp.fromDate(expiry),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }).then(() => {
                alert('Approved!');
            }).catch(error => alert(error));
        }

        // Markets tab
        function loadMarkets() {
            db.collection('markets').onSnapshot(snapshot => {
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div class="card">
                            <strong>${data.name}</strong><br>
                            <button onclick="editMarket('${doc.id}')">Edit</button>
                        </div>
                    `;
                });
                document.getElementById('marketsList').innerHTML = html;
            });
        }

        function editMarket(id) {
            const name = prompt('Enter market name:');
            if (name === null) return;
            const headline = prompt('Enter headline:');
            const r1 = prompt('Result 1:');
            const r2 = prompt('Result 2:');
            const r3 = prompt('Result 3:');
            const r4 = prompt('Result 4:');
            const notice = prompt('Notice:');
            db.collection('markets').doc(id).update({
                name, headline,
                result1: r1, result2: r2, result3: r3, result4: r4,
                notice
            }).then(() => alert('Updated'));
        }

        // Formulas tab
        function loadFormulas() {
            db.collection('formulas').onSnapshot(snapshot => {
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div class="card">
                            <strong>${data.title}</strong><br>
                            <button onclick="editFormula('${doc.id}')">Edit</button>
                        </div>
                    `;
                });
                document.getElementById('formulasList').innerHTML = html;
            });
        }

        function editFormula(id) {
            const title = prompt('Enter formula title:');
            if (title === null) return;
            const content = prompt('Enter formula content:');
            db.collection('formulas').doc(id).update({ title, content })
                .then(() => alert('Updated'));
        }

        // Settings tab
        function loadSettings() {
            db.collection('siteSettings').doc('settings').get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('settingsForm').innerHTML = `
                        <div class="card">
                            <label>Logo URL</label>
                            <input type="text" id="logoUrl" value="${data.logoUrl || ''}">
                            <label>Headline</label>
                            <input type="text" id="headline" value="${data.headline || ''}">
                            <label>WhatsApp Number</label>
                            <input type="text" id="whatsapp" value="${data.whatsappNumber || ''}">
                            <button onclick="saveSettings()">Save Settings</button>
                        </div>
                    `;
                }
            });
        }

        function saveSettings() {
            const logoUrl = document.getElementById('logoUrl').value;
            const headline = document.getElementById('headline').value;
            const whatsapp = document.getElementById('whatsapp').value;
            db.collection('siteSettings').doc('settings').set({ logoUrl, headline, whatsappNumber: whatsapp }, { merge: true })
                .then(() => alert('Settings saved!'));
        }

        function logout() {
            auth.signOut().then(() => window.location.href = 'login.html');
        }

        // Initial load
        showTab('payments');
    </script>
</body>
</html>
